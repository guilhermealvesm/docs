---
title: "Eventos Microservice"
description: "Description of your new file."
---

````mdx
---
title: Documentação Completa dos Eventos do Sistema
description: Guia detalhado dos eventos, filas e handlers do sistema.
---

# Documentação Completa dos Eventos do Sistema

## Índice
1. [Eventos RabbitMQ](#eventos-rabbitmq)
2. [Eventos BullMQ (Redis)](#eventos-bullmq-redis)
3. [Handlers do Baileys](#handlers-do-baileys)
4. [Consumidores](#consumidores)
5. [Produtores](#produtores)
6. [Configurações](#configuracoes)

---

## Eventos RabbitMQ

### Notification Consumer

**Arquivo:** `Backend-1/src/consumers/notification.consumer.ts`

**Descrição:** Consumidor para notificações em tempo real via Socket.IO

**Queue:** `notification-queue`

**Estrutura da Mensagem:**

```ts
{
  namespace: string,    // Namespace do Socket.IO
  channel: string,      // Canal do evento
  data: any             // Dados da notificação
}
```

**Funcionalidade:** Emite eventos via Socket.IO para o frontend em tempo real

---

### Check Contact Number Producer

**Arquivo:** `Backend-1/src/producers/check-contact-number.producer.ts`

**Descrição:** Produtor para verificar números de contato

**Queue:** `check-contact-number-queue`

**Parâmetros:**
- `number: string`
- `companyId: number`
- `isGroup: boolean`

---

### Create or Update Contact Producer

**Arquivo:** `Backend-1/src/producers/create-or-update-contact.producer.ts`

**Descrição:** Produtor para criar ou atualizar contatos

**Queue:** `create-or-update-contact-queue`

**Parâmetros:**
- `whatsappId: string`
- `name: string`
- `number: string`
- `isGroup: boolean`
- `email: string`
- `profilePicUrl: string`
- `companyId: number`
- `channel: string`
- `extraInfo: any`
- `remoteJid: string`

---

### Get Profile Picture Producer

**Arquivo:** `Backend-1/src/producers/get-profile-picture.producer.ts`

**Descrição:** Produtor para obter foto de perfil

**Queue:** `get-profile-picture-queue`

**Parâmetros:**
- `number: string`
- `companyId: number`
- `whatsappId: number`
- `contact?: Contact`

---

## Eventos BullMQ (Redis)

### Message Queue Producer

**Arquivo:** `Backend-1/src/queues/producers/make-message.producer.ts`

**Configurações:**

```ts
MESSAGE_QUEUE_OPTIONS = {
  attempts: 3,
  backoff: {
    type: "exponential",
    delay: 100
  },
  removeOnComplete: true,
  removeOnFail: false
}
```

**Funcionalidade:** Cria filas por empresa (`message-queue-company-${companyId}`)

---

### Message Ack Queue Producer

**Arquivo:** `Backend-1/src/queues/producers/make-message-ack.producer.ts`

**Configurações:** Mesmo que o Message Queue Producer

**Funcionalidade:** Fila de confirmações por empresa (`message-ack-queue-company-${companyId}`)

---

### Queue Workers

**Arquivo:** `Backend-1/src/queues/index.ts`

**Funcionalidades:**
- Inicialização de workers
- Monitoramento de eventos
- Shutdown gracioso

**Filas:**
- `message-queue-company-${companyId}`
- `message-ack-queue-company-${companyId}`

---

## Handlers do Baileys

### Configuração do Event Bus

**Arquivo:** `channel-2/src/bus-rabbitmq/bus-rabbitmq.ts`

```ts
{
  queueName: "event-bus-queue",
  connectionString: "amqp://guest:guest@localhost",
  maxRetries: 3,
  persistentMessages: true,
  frameMax: 0
}
```

### Handlers:

- **BaileysConnectHandler**: Conexão do WhatsApp
- **BaileysRemoveHandler**: Remoção de conexão
- **BaileysRestartHandler**: Reinício de conexão
- **BaileysReadMessagesHandler**: Leitura de mensagens
- **BaileysDeleteMessageHandler**: Exclusão de mensagens
- **BaileysSendApiMessageHandler**: Envio via API
- **BaileysSendRawMessageHandler**: Envio raw
- **BaileysSendMediaMessageHandler**: Envio de mídia
- **BaileysSendApiMediaMessageHandler**: Mídia via API
- **BaileysSendMessageHandler**: Envio padrão
- **BaileysSendProtoMessageHandler**: Envio protobuf

---

## Configurações

### Variáveis de Ambiente

```bash
RABBITMQ_URI=amqp://guest:guest@localhost
RABBITMQ_QUEUE_NAME=event-bus-queue
REDIS_MSG_QUEUE=true
REDIS_URI_MSG_CONNECTION=redis://localhost:6379
NODE_ENV=development
```

### Concorrência e Retry

- **Concorrência:** 5 handlers
- **Retry Policy:** 3 tentativas com backoff exponencial
- **Persistência:** Mensagens persistentes habilitadas

---

## Fluxo de Eventos

### Recebimento de Mensagem

1. Baileys recebe
2. `BaileysReadMessagesHandler` processa
3. Vai para Redis
4. Worker salva no banco
5. Notifica via Socket.IO

### Envio de Mensagem

1. Frontend solicita
2. `BaileysSendMessageHandler` processa
3. Baileys envia
4. Confirmação via `BaileysSendMessageAckHandler`

### Notificações em Tempo Real

1. Evento backend
2. `NotificationConsumer` recebe
3. Emissão Socket.IO
4. Frontend atualiza UI

---

## Monitoramento e Logs

### Eventos:
- `drained`, `completed`, `failed`, `error`
- Tempo de mensagem
- Status de conexão

### Logs:
- Inicialização
- Falhas
- Duração
- Conexões

---

## Troubleshooting

### Problemas Comuns

1. **Mensagens não processadas:**
   - `REDIS_MSG_QUEUE=true`
   - Redis up
   - Workers ativos

2. **Notificações ausentes:**
   - RabbitMQ up
   - `NotificationConsumer` ativo
   - Socket.IO configurado

3. **Conexões Baileys falhando:**
   - Handlers registrados
   - Event Bus ok
   - Ver logs

### Comandos de Debug

```bash
ps aux | grep node
redis-cli LLEN message-queue-company-1
rabbitmqctl list_queues
````